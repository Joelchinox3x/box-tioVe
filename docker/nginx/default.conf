# Proxy inverso de proforma.tradimacova.com apuntando a PROFORMAMVC
server {
    listen 80;
    listen 443 ssl;
    server_name proforma.tradimacova.com www.proforma.tradimacova.com;

    # Certificado SSL (Mantenemos los mismos)
    ssl_certificate /etc/letsencrypt/live/proforma.tradimacova.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/proforma.tradimacova.com/privkey.pem;

    # CAMBIO 1: El root debe apuntar a la carpeta public de proformamvc
    root /var/www/proformamvc/public;
    index index.php index.html;

    client_max_body_size 50M;

    # CAMBIO 2: Manejo de archivos estáticos (Assets, Uploads, etc.)
    # Al estar en el dominio raíz, no necesitan el prefijo /proformamvc/
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # CAMBIO 3: Procesamiento PHP dirigido al contenedor PROFORMAMVC
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass proformamvc:9000; # Apuntamos al nuevo contenedor
        include fastcgi_params;
        # Importante: El path dentro del contenedor
        fastcgi_param SCRIPT_FILENAME /var/www/proformamvc/public/index.php;
        fastcgi_param QUERY_STRING $query_string;
    }

    error_log  /var/log/nginx/proformamvc_error.log;
    access_log /var/log/nginx/proformamvc_access.log;
}

server {
    listen 80;
    index index.php index.html;
    server_name boxtiove.com www.boxtiove.com;

    # IMPORTANTE: Cambiamos el root a la carpeta del Frontend
    root /var/www/app;

    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;

    # Permitir archivos de hasta 50MB (para uploads de imágenes y PDFs)
    client_max_body_size 50M;

    location /files {
        alias /var/www/html/files/;
        try_files $uri =404;
        access_log off;
        expires 30d;
    }

    # 1. FRONTEND REACT (RAÍZ)
    location / {
        # Intenta cargar el archivo real, si no existe va al index.html (para React Router)
        try_files $uri $uri/ /index.html;
    }

    # 2. BOXEVENT API
    location ~ ^/api/(.*)$ {
        fastcgi_pass backend:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param REQUEST_URI /api/$1;
        fastcgi_param QUERY_STRING $query_string;
    }

    # 3. PROFORMA-APP (Tradicional)
    location = /proforma { return 301 /proforma/; }
    
    location ~ ^/proforma/(.+\.php)$ {
        fastcgi_pass proforma-app:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/proforma-app/$1;
        fastcgi_param QUERY_STRING $query_string;
    }

    # Directorio y archivos estáticos proforma-app
    location /proforma/ {
        alias /var/www/proforma-app/;
        index index.php index.html;
    }

    # 4. PROFORMAMVC (Estructura de Carpeta Public)
    location = /proformamvc { return 301 /proformamvc/; }

    # 4.1 PROFORMAMVC - Archivos estáticos con prioridad (^~ previene regex matching)
    location ^~ /proformamvc/assets/ {
        alias /var/www/proformamvc/public/assets/;
    }

    location ^~ /proformamvc/uploads/ {
        alias /var/www/proformamvc/public/uploads/;
    }

    location ^~ /proformamvc/pdfs/ {
        alias /var/www/proformamvc/public/pdfs/;
    }

    # 4.2 PROFORMAMVC - Rutas dinámicas PHP
    location /proformamvc/ {
        fastcgi_pass proformamvc:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/proformamvc/public/index.php;
        fastcgi_param SCRIPT_NAME /proformamvc/index.php;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param DOCUMENT_ROOT /var/www/proformamvc/public;
        fastcgi_param QUERY_STRING $query_string;
    }

    # 5. SOPORTE PHP GENERAL (Por si acaso)
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_pass backend:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}
